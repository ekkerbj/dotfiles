#!/bin/bash
# ralph.sh - Finalized Resilient Loop (Verbose Mode)

if ! command -v jq &> /dev/null; then
    echo "‚ùå Error: 'jq' is not installed."
    exit 1
fi

PRD="prd.json"
PROGRESS="progress.txt"
LIMIT=${1:-10}

touch "$PROGRESS"

echo "üöÄ Starting Ralph Loop ($LIMIT max iterations)"

for ((i=1; i<=LIMIT; i++)); do
  # 1. External State Verification
  INCOMPLETE_TASKS=$(jq '[.backlog[] | select(.passes == false)] | length' "$PRD")
  
  if [[ "$INCOMPLETE_TASKS" -eq 0 ]]; then
    echo "‚úÖ Success: PRD completed prior to iteration."
    break
  fi

  echo -e "\n--- Iteration $i: $INCOMPLETE_TASKS tasks remaining ---"

  # 2. Agent Execution
  # Removed --quiet to prevent startup failures.
  OUTPUT=$(opencode run "
    @AGENTS.md @$PRD @$PROGRESS
    
    CONTEXT: Using instructions from @AGENTS.md.  Read the adr/ files and other documentation to understand architectural decisions.
    GOAL: Complete the next failing task in $PRD.
    
    1. Update $PRD (set 'passes': true) only after verification.  That includes a successful build with no errors, including ALL tests passing ( unit and instrumented tests ).
    2. Append a single summary line of work performed to $PROGRESS.
    3. Output 'STOP_LOOP' only if the entire backlog is true.
    4. Create or update an ADR for technical and architectural decisions.
  ")

  # 3. Persistence Logic
  git add .
  if ! git diff --cached --quiet; then
    LOG_MSG=$(grep '[^[:space:]]' "$PROGRESS" | tail -n 1 | xargs)
    COMMIT_MSG="ralph #$i: ${LOG_MSG:-Advancing PRD implementation}"
    
    git commit -m "$COMMIT_MSG" --quiet
    echo "Committed: $COMMIT_MSG"
  else
    echo "‚ö†Ô∏è Warning: No file changes detected in iteration $i."
  fi

  # 4. Process Exit Signal
  if echo "$OUTPUT" | grep -q "STOP_LOOP"; then
    echo "‚úÖ AI signaled completion. Exiting loop."
    break
  fi

  # 5. Maintenance
  [ -f "$PROGRESS" ] && tail -n 15 "$PROGRESS" > "${PROGRESS}.tmp" && mv "${PROGRESS}.tmp" "$PROGRESS"
done
